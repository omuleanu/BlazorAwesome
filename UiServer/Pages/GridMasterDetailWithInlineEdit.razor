@page "/GridMasterDetailWithInlinEdit"
@using Omu.BlazorAwesome.Core
@inject IDbContextFactory<MyContext> cxf
<div class="expl">
    Master detail grid with inline editing for both the master and the detail grid.
</div>
<br />
<div class="bar">
    <OButton OnClick="() => restaurantGridOpt.State.InlineEdit.Create(new RestaurantInput())">Create</OButton>
    <OButton OnClick="() => restaurantGridOpt.State.InlineEdit.CancelAll()">Cancel all</OButton>
    <OButton OnClick="async () => await restaurantGridOpt.State.InlineEdit.SaveAllAsync()">Save all</OButton>
</div>

<OGrid Opt="restaurantGridOpt" @ref="restaurantGridRef" />

<OConfirm @ref="delPopup" ModOpt="setConfirmOpt">
    Are you sure you want to delete restaurant: <b>@delName</b> ?
</OConfirm>
<br />
<br />

@code
{
    private OConfirm delPopup;
    private string delName;

    // used to higlight row when confirming delete
    private int? delKey;

    private OGrid<Restaurant> restaurantGridRef;

    private GridOpt<Restaurant> restaurantGridOpt = new();

    protected override void OnInitialized()
    {
        initGrid();
    }

    private void setConfirmOpt(PopupOpt opt)
    {
        opt.OnClose = async () =>
        {
            delKey = null;
            restaurantGridOpt.State.Render();
        };
    }

    private void confirmDelete(Restaurant item)
    {
        delName = item.Name;
        delKey = item.Id;
        delPopup.Open(async () =>
        {
            using var mcx = cxf.CreateDbContext();
            mcx.Remove<Restaurant>(item);

            await mcx.SaveChangesAsync();

            await restaurantGridOpt.State.LoadAsync();
        });
    }

    private RenderFragment getRestaurantDetailsNest(Restaurant entity, object key = null)
    {
        return @<RestaurantDinnersInlineEdit Restaurant="entity"></RestaurantDinnersInlineEdit>;
    }

    private void initGrid()
    {
        restaurantGridOpt.KeyProp = m => m.Id;
        restaurantGridOpt.EFData(cxf, cx => cx.Restaurants);

        restaurantGridOpt.Column(new Column<Restaurant>()
            {
                Width = 150,
                Label = "edit",
                Render = restaurant =>

    @<OButton CssClass="@restaurantGridOpt.State.Nesting.NestClass(restaurant.Id)"
                  OnClick="() => restaurantGridOpt.State.Nesting.ToggleOpen(new(){ Key = restaurant.Id, Render = getRestaurantDetailsNest(restaurant)})">
        <i class="o-caretc"><i class="o-caret"></i></i> details
    </OButton>
        });

        restaurantGridOpt.Column(new()
            {
                For = c => c.Id,
                Width = 100
            });

        restaurantGridOpt.Column(new()
            {
                For = c => c.Name
            })
            .Editor(ORender.TextBox(restaurantGridOpt));

        restaurantGridOpt.Column(ORender.InlEditColumn(this, restaurantGridOpt));
        restaurantGridOpt.Column(ORender.InlDeleteColumn(this, restaurantGridOpt, confirmDelete));

        restaurantGridOpt.RowClassFunc = itm =>
        {
            if (itm is not null && delKey == itm.Id)
            {
                return "awe-hl";
            }

            return null;
        };

        restaurantGridOpt.InlineEdit = new();

        restaurantGridOpt.InlineEdit.GetModel = entity => new RestaurantInput
            {
                Id = entity.Id,
                Name = entity.Name
            };

        restaurantGridOpt.InlineEdit.SaveAll = async items =>
            {
                var saved = new List<string>();
                foreach (var state in items)
                {
                    if (await saveItemAsync(state))
                    {
                        saved.Add(state.Key);
                    }
                }

                return saved;
            };
    }

    private async Task<bool> saveItemAsync(EditItemState<Restaurant> edstate)
    {
        var input = (RestaurantInput)edstate.Input;

        using var mcx = cxf.CreateDbContext();

        if (!edstate.EditContext.Validate()) return false;

        var model = edstate.IsCreate ? new() :
            await mcx.Restaurants            
            .FirstAsync(o => o.Id == input.Id);

        model.Name = input.Name;
        
        if (edstate.IsCreate)
        {
            mcx.Add<Restaurant>(model);
        }
        else
        {
            mcx.Update(model);
        }

        mcx.SaveChanges();

        AweUtil.FlashRow(restaurantGridOpt, model.Id);
        return true;
    }
}